#!/bin/bash

thisBin="${BASH_SOURCE[0]}"
tmpDirDef="${tmpDirDef:-${TMPDIR:-/tmp/}}"

if [ "-w" = "$1" ]; then
	if [ -n "$_oo_VERBOSE" ]; then
		echo "[arguments for -w]" >&2
		echo "$*" >&2
		echo >&2
	fi

	shift
	wrapDir="$1"; shift
	base="$1"; shift

	echo -n "$base "
	for i in lhs rhs; do
		filepath="$1"; shift

		if [ "$filepath" = "$base" ] || [ "$filepath" = "/dev/null" ]; then
			echo -n "$filepath "
		else
			{
				mkdir -p ${_oo_VERBOSE:+-v} "$wrapDir/$i"
				mkdir -p ${_oo_VERBOSE:+-v} "$(dirname "$wrapDir/$i/$base")"
				if ! ln ${_oo_VERBOSE:+-v} "$filepath" "$wrapDir/$i/$base"; then
					cp ${_oo_VERBOSE:+-v} "$filepath" "$wrapDir/$i/$base"
				fi
			} >&2
			echo -n "$wrapDir/$i/$base "
		fi
	done
	echo

	exit 0
fi

if [ "-n" = "$1" ]; then
	if [ "$2" -eq "$2" ]; then
		set -- "@~$2" "@~$(($2 - 1))"
	else
		exit $?
	fi
fi

if gitRoot="$(git rev-parse --show-cdup)"; then
	cd "${gitRoot:-.}" || exit 1
else
	exit $?
fi

MakeTempDir()
{
	local tplPrefix="$1"; shift

	if [ "$(uname -s)" = Darwin ]; then
		mktemp -d -t "$tplPrefix"
	else
		mktemp -d --tmpdir -- "$tplPrefix.XXXXXXXX"
	fi
}

tempDir="$(MakeTempDir "gdf")"
tempDirDiff="$tempDir/diff"
tempDirVimRC="$tempDir/vimrc"

_exit() {
	rm -rf "$tempDir"
	exit $1
}

if [ -n "$_oo_VERBOSE" ]; then
	echo "invoking git-difftool..."
	echo "force apply options --no-prompt --tool=vimdiff..."
	echo
fi

gdfCmd=( git difftool -y -x "_oo_VERBOSE=\"$_oo_VERBOSE\" \"$thisBin\" -w \"$tempDirDiff\" \"\$BASE\"" "$@" )
if [ -n "$_oo_VERBOSE" ]; then
	echo "[gdfCmd]"
	echo "${gdfCmd[*]}"
	echo
fi

create_vimrc() {
	if [ 0 -eq $# ]; then
		return 1
	fi

	echo "au! BufEnter *"
	while [ $# -ge 3 ]; do
		echo "tabe $3"
		echo "vert diffsplit $2"
		echo "if exists(\":TabooRename\")"
		echo "	TabooRename $1"
		echo "endif"
		shift 3
	done
	echo "tabfirst"
	echo "tabclose"
}

gdfCmdResult="$("${gdfCmd[@]}")"
if [ -n "$_oo_VERBOSE" ]; then
	echo "[gdfCmdResult]"
	echo "$gdfCmdResult"
	echo
fi

create_vimrc $gdfCmdResult > "$tempDirVimRC"
if [ -n "$_oo_VERBOSE" ]; then
	echo "[vimrc ($tempDirVimRC)]"
	cat "$tempDirVimRC"
	echo
fi

if [ -s "$tempDirVimRC" ]; then
	if [ -z "$_oo_DRYRUN" ]; then
		vim -S "$tempDirVimRC"
	fi
else
	echo "No difference found !" >&2
fi

_exit 0
