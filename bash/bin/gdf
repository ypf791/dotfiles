#!/bin/bash

tmpDirDef="${tmpDirDef:-${TMPDIR:-/tmp/}}"

if [ "-w" = "$1" ]; then
	if [ -n "$_oo_VERBOSE" ]; then
		echo "[arguments for -w]" >&2
		echo "$*" >&2
		echo >&2
	fi

	shift
	wrapDir="$1"; shift
	base="$1"; shift

	echo -n "$base "
	for i in lhs rhs; do
		filepath="$1"; shift

		if [ "$filepath" = "$base" ] || [ "$filepath" = "/dev/null" ]; then
			echo -n "$filepath "
		else
			{
				mkdir -p ${_oo_VERBOSE:+-v} "$wrapDir/$i"
				mkdir -p ${_oo_VERBOSE:+-v} "$(dirname "$wrapDir/$i/$base")"
				if ! ln ${_oo_VERBOSE:+-v} "$filepath" "$wrapDir/$i/$base"; then
					cp ${_oo_VERBOSE:+-v} "$filepath" "$wrapDir/$i/$base"
				fi
			} >&2
			echo -n "$wrapDir/$i/$base "
		fi
	done
	echo

	exit 0
fi

gitRoot=
if ! gitRoot=`git rev-parse --git-dir`; then
	exit $?
fi
gitRoot=`dirname $gitRoot`

cd $gitRoot
if [ 'Darwin' = `uname -s` ]; then
	tempDir=`mktemp -d -t "gdf"` || exit 1
	tempRc=`mktemp -t "gdf.vim"` || exit 1
else
	tempDir=`mktemp -d -p $tmpDirDef -t "gdf_XXXX"` || exit 1
	tempRc=`mktemp -p $tempDir -t "vim.XXXX"` || exit 1
fi
cd - >/dev/null

_exit() {
	rm -f "$tempRc"
	rm -rf "$tempDir"
	exit $1
}

if [ -n "$_oo_VERBOSE" ]; then
	echo "invoking git-difftool..."
	echo "force apply options --no-prompt --tool=vimdiff..."
fi

gdfCmd="git difftool"
appendCmd="-y -x '_oo_VERBOSE=\"$_oo_VERBOSE\" \"`basename ${BASH_SOURCE[0]}`\" -w \"$tempDir\" \"\$BASE\"'"
while [ 0 -lt $# ]; do
	if [ "--" != "$1" ]; then
		gdfCmd="$gdfCmd \"$1\""
	else
		gdfCmd="$gdfCmd $appendCmd --"
		appendCmd=""
	fi
	shift
done
gdfCmd="$gdfCmd $appendCmd"

[ 0 -ne $? ] && exit $?

deleted_files="$tempDir/.deleted_files"

parse_vimrc() {
	if [ 0 -eq $# ]; then
		return 1
	fi
	echo "au! BufEnter *" >> $tempRc
	while [ $# -ge 3 ]; do
		if [ "/dev/null" = "$3" ]; then
			echo "$1" >> $deleted_files
		else
			echo "tabe $3" >> $tempRc
			if ! [ "/dev/null" = "$2" ]; then
				echo "vert diffsplit $2" >> $tempRc
			fi
			echo "if exists(\":TabooRename\")" >> $tempRc
			echo "	TabooRename $1" >> $tempRc
			echo "endif" >> $tempRc
		fi
		shift 3
	done
}

cd $gitRoot
gdfCmdResult="$(eval "$gdfCmd")"
parse_vimrc $gdfCmdResult
if [ -n "$_oo_VERBOSE" ]; then
	echo "[gdfCmd]"
	echo "$gdfCmd"
	echo
	echo "[gdfCmdResult]"
	echo "$gdfCmdResult"
	echo
	echo "[vimrc ($tempRc)]"
	cat "$tempRc"
fi

if [ -s $tempRc ]; then
	echo "tabfirst" >> $tempRc
	if [ -s $deleted_files ]; then
		echo "e $deleted_files" >> $tempRc
	else
		echo "tabclose" >> $tempRc
	fi
	if [ -z "$_oo_DRYRUN" ]; then
		vim -S "$tempRc"
	fi
else
	echo "No difference found !" >&2
fi

_exit 0
